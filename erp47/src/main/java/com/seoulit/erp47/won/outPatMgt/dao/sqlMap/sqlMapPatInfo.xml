<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.seoulit.erp47.won.outPatMgt.dao.PatInfoDAO">
	<cache eviction="LRU" flushInterval="86400000"/>
	<select id="selectPatList" resultType="patInfoBean">
		select p.PAT_NO , p.PAT_NM, p.RRN1 , p.AGE , p.TEL , p.ADDR , p.BARR_ASS , p.DTL_ADDR , p.ZIP , p.DEATH_DATE , 
		p.NOTE , p.GENDER , p.SMS_RECEIVE_YB , p.SMS_RECEIVE_NO , p.SMS_RECEIVER, p.REC_NW_DATE, FN_WS_DECRYPT(RRN2) as RRN2, 
		p.ESTB_GIHO, p.CERTFCT_NO, p.INSU_RRN, p.INSU_NM, p.APPLY_START_DATE, p.APPLY_END_DATE, o.OUTPA_RECEIPT_NO, h.HOSPTLZ_RECEIPT_NO FROM WS_PAT p, (SELECT pat_no, MAX(outpa_receipt_no) OUTPA_RECEIPT_NO 
		FROM WS_OUTPA_RECEIPT GROUP BY pat_no) o, (SELECT hosptlz_receipt_no, pat_no FROM WH_HOSPTLZ_RECEIPT) h 
		WHERE p.pat_no = o.pat_no(+) AND o.pat_no = h.pat_no(+) 
		<if test="patNm != '' and patNm != null"> 
			AND p.PAT_NM LIKE '%'||#{patNm}||'%' 
		</if>
		<if test="tel != '' and tel != null"> 
			AND p.TEL LIKE '%'||#{tel}||'%' 
		</if>
		<if test="rrn1 != '' and rrn1 != null and rrn2 != '' and rrn2 != null">
		 	AND p.RRN1=#{rrn1} AND FN_WS_DECRYPT(p.RRN2)=#{rrn2} 
		</if>
		order by pat_no 
	</select>
	
	<select id="selectPat" resultType="patInfoBean"> 
		SELECT PAT_NO , PAT_NM, RRN1 , AGE , TEL , ADDR , BARR_ASS , DTL_ADDR , ZIP , DEATH_DATE , NOTE , GENDER , SMS_RECEIVE_YB , SMS_RECEIVE_NO , SMS_RECEIVER, (SELECT MAX(RECEIPT_DATE) REC_NW_DATE 
		FROM WS_OUTPA_RECEIPT 
		where pat_no = #{patNo} 
		GROUP BY pat_no) AS REC_NW_DATE, FN_WS_DECRYPT(RRN2) AS RRN2, ESTB_GIHO, CERTFCT_NO, INSU_RRN, INSU_RRN1, INSU_NM, APPLY_START_DATE, APPLY_END_DATE from WS_PAT where PAT_NO= #{patNo} 
	</select>
</mapper>
		